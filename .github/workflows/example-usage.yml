name: Terraform PR Validation

on:
  pull_request:
    paths:
      - '**.tf'
      - '**.tfvars'

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      ###########################################
      # Step 1: Generate and Display Plan
      ###########################################
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -backend=false
      
      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check
        continue-on-error: true
      
      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate
      
      - name: Terraform Plan
        id: plan
        working-directory: ./terraform
        run: |
          terraform plan -out=plan.tfplan -no-color 2>&1 | tee plan-output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Post Plan to PR Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('./terraform/plan-output.txt', 'utf8');
            
            // Truncate if too long (GitHub has comment size limits)
            const maxLength = 65000;
            const truncated = planOutput.length > maxLength 
              ? planOutput.substring(0, maxLength) + '\n\n... (truncated)'
              : planOutput;
            
            const output = `#### Terraform Plan ðŸ“–
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            </details>
            
            **Plan Exit Code**: \`${{ steps.plan.outputs.exitcode }}\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
      
      ###########################################
      # Step 2: Validate Tags (runs own plan)
      ###########################################
      - name: Validate Terraform Tags
        uses: YOUR-USERNAME/tag-enforcement-test@v1
        with:
          terraform_directory: ./terraform
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
      
      ###########################################
      # Step 3: Summary
      ###########################################
      - name: Add Summary
        if: always()
        run: |
          echo "## Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | ${{ steps.plan.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ steps.plan.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Plan | ${{ steps.plan.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag Validation | ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
