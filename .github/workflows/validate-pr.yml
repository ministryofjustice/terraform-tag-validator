name: Validate PR Tags

# This workflow will FAIL if tag violations are detected
# To block PR merges, add this as a required status check in branch protection

on:
  pull_request:
    paths:
      - '**.tf'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-tags:
    name: Validate Terraform Tags
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check if test-terraform exists
        id: check-terraform
        run: |
          if [ -d "test-terraform" ]; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate test-terraform (if exists)
        if: steps.check-terraform.outputs.has_terraform == 'true'
        id: validate-scenarios
        uses: ./
        with:
          terraform_directory: ./test-terraform
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
            environment-name
      
      # Post results as PR comment
      - name: Post Validation Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            let commentBody = '## üè∑Ô∏è Tag Validation Results\n\n';
            
            const scenariosOutcome = '${{ steps.validate-scenarios.outcome }}';
            const violationsSummary = `${{ steps.validate-scenarios.outputs.violations_summary }}`;
            const violationsCount = '${{ steps.validate-scenarios.outputs.violations_count }}';
            
            if (scenariosOutcome === 'success') {
              commentBody += '‚úÖ **All resources have required tags**\n\n';
              commentBody += 'Tag validation passed. All Terraform resources comply with MoJ tagging standards.\n';
            } else if (scenariosOutcome === 'failure') {
              commentBody += '### Violations Found\n\n';
              
              if (violationsSummary && violationsSummary.trim()) {
                commentBody += violationsSummary + '\n\n';
              } else {
                commentBody += '‚ùå **Tag validation failed**\n\n';
                commentBody += 'Some resources are missing required tags or have invalid values.\n\n';
              }
              
              commentBody += '---\n\n';
              commentBody += '**Required tags:**\n';
              commentBody += '- `business-unit` (HMPPS, OPG, LAA, Central Digital, Technology Services, HMCTS, CICA, Platforms)\n';
              commentBody += '- `application` (any non-empty value)\n';
              commentBody += '- `owner` (format: "Team Name: email@example.com")\n';
              commentBody += '- `is-production` ("true" or "false")\n';
              commentBody += '- `service-area` (any non-empty value)\n';
              commentBody += '- `environment-name` (production, staging, test, development)\n\n';
              commentBody += `[View workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            } else if (scenariosOutcome === 'skipped') {
              commentBody += '‚ÑπÔ∏è **No Terraform files to validate**\n\n';
              commentBody += 'Tag validation skipped - no `.tf` files found in changed paths.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
