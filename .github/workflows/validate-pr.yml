name: Validate PR Tags

# This workflow will FAIL if tag violations are detected
# To block PR merges, add this as a required status check in branch protection

on:
  pull_request:
    paths:
      - '**.tf'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-tags:
    name: Validate Terraform Tags
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Validate test-scenarios directory if it exists
      - name: Check if test-scenarios exists
        id: check-scenarios
        run: |
          if [ -d "test-scenarios" ]; then
            echo "has_scenarios=true" >> $GITHUB_OUTPUT
          else
            echo "has_scenarios=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate test-scenarios (if exists)
        if: steps.check-scenarios.outputs.has_scenarios == 'true'
        id: validate-scenarios
        uses: ./
        # NOTE: Removed continue-on-error so violations will FAIL the check
        with:
          terraform_directory: ./test-scenarios
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
      
      # Post results as PR comment
      - name: Post Validation Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let commentBody = '## üè∑Ô∏è Tag Validation Results\n\n';
            
            const scenariosOutcome = '${{ steps.validate-scenarios.outcome }}';
            
            if (scenariosOutcome === 'success') {
              // SUCCESS - All tags valid
              commentBody += '‚úÖ **All resources have required tags**\n\n';
              commentBody += 'Tag validation passed. All Terraform resources comply with MoJ tagging standards.\n';
            } else if (scenariosOutcome === 'failure') {
              // FAILURE - Violations found
              commentBody += '‚ùå **Tag validation failed**\n\n';
              commentBody += 'Some resources are missing required tags or have invalid values.\n\n';
              commentBody += '**Required tags:**\n';
              commentBody += '- `business-unit` (HMPPS, OPG, LAA, Central Digital, Technology Services, HMCTS, CICA, Platforms)\n';
              commentBody += '- `application` (any non-empty value)\n';
              commentBody += '- `owner` (format: "Team: email@example.com")\n';
              commentBody += '- `is-production` ("true" or "false")\n';
              commentBody += '- `service-area` (any non-empty value)\n\n';
              commentBody += '**Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed violation information.**\n';
            } else if (scenariosOutcome === 'skipped') {
              // SKIPPED - No Terraform files found
              commentBody += '‚ÑπÔ∏è **No Terraform files to validate**\n\n';
              commentBody += 'Tag validation skipped - no `.tf` files found in changed paths.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
