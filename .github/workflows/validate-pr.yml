name: Validate PR Tags

on:
  pull_request:
    paths:
      - '**.tf'
      - 'test-scenarios/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-tags:
    name: Validate Terraform Tags
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Validate test-scenarios directory if it exists
      - name: Check if test-scenarios exists
        id: check-scenarios
        run: |
          if [ -d "test-scenarios" ]; then
            echo "has_scenarios=true" >> $GITHUB_OUTPUT
          else
            echo "has_scenarios=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate test-scenarios (if exists)
        if: steps.check-scenarios.outputs.has_scenarios == 'true'
        id: validate-scenarios
        uses: ./
        continue-on-error: true
        with:
          terraform_directory: ./test-scenarios
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
      
      # Post results as PR comment
      - name: Post Validation Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let commentBody = '## üè∑Ô∏è Tag Validation Results\n\n';
            
            const scenariosOutcome = '${{ steps.validate-scenarios.outcome }}';
            
            if (scenariosOutcome === 'success') {
              commentBody += '‚úÖ **All Terraform resources have required tags!**\n\n';
              commentBody += 'All resources in `test-scenarios/` directory passed validation.\n';
            } else if (scenariosOutcome === 'failure') {
              commentBody += '‚ùå **Tag validation failed**\n\n';
              commentBody += 'Some resources are missing required tags or have invalid values.\n\n';
              commentBody += '**Required tags:**\n';
              commentBody += '- `business-unit` (allowed: HMPPS, OPG, LAA, Central Digital, Technology Services, HMCTS, CICA, Platforms)\n';
              commentBody += '- `application` (any non-empty value)\n';
              commentBody += '- `owner` (format: "Team: email@example.com")\n';
              commentBody += '- `is-production` (allowed: "true", "false")\n';
              commentBody += '- `service-area` (any non-empty value)\n\n';
              commentBody += '**Check the workflow logs for detailed violation information.**\n';
            } else if (scenariosOutcome === 'skipped') {
              commentBody += '‚è≠Ô∏è **No test-scenarios directory found**\n\n';
              commentBody += 'Tag validation skipped - no Terraform files to validate.\n';
            }
            
            commentBody += '\n---\n';
            commentBody += `**Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
